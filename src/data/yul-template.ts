import { ALPHABET } from "./constants";

export enum YulSection {
  Constructor = "constructor",
  Dispatchers = "dispatchers",
  Functions = "functions",
  ConstructorFunctions = "constructor functions",
  StorageLayout = "storage layout",
  ConstructorStorageLayout = "constructor storage layout",
  StorageAccess = "storage access",
  ConstructorStorageAccess = "constructor storage access",
  Events = "events",
  ConstructorEvents = "constructor events",
}

const utilityFunctions: string[] = [
  ``,
  ``,
  `/* ---------- utility functions ---------- */`,
  `function safeAdd(a, b) -> r {`,
  `r := add(a, b)`,
  `if or(lt(r, a), lt(r, b)) { revert(0, 0) }`,
  `}`,
  `function safeSub(x, y) -> z {`,
  `z := sub(x, y)`,
  `if gt(y, x) { revert(0, 0) }`,
  `}`,
  `function safeMul(x, y) -> z {`,
  `if iszero(or(eq(y, 0), eq(div(mul(x, y), y), x))) { revert(0, 0) }`,
  `z := mul(x, y)`,
  `}`,
  `function revert256(_v) {`,
  `mstore(0, _v)`,
  `revert(0, 0x20)`,
  `}`,
  `function require(arg, message) {`,
  `if iszero(arg) {`,
  `revert256(message)`,
  `}`,
  `}`,
  `function gte(x, y) -> result {`,
  `result := iszero(lt(x, y))`,
  `}`,
  `function lte(x, y) -> result {`,
  `result := iszero(gt(x, y))`,
  `}`,
  `function neq(x, y) -> result {`,
  `result := iszero(eq(x, y))`,
  `}`,
  `function extract_byte_array_length(data) -> length {`,
  `length := div(data, 2)`,
  `let outOfPlaceEncoding := and(data, 1)`,
  `if iszero(outOfPlaceEncoding) {`,
  `length := and(length, 0x7f)`,
  `}`,
  `}`,

  // Hash functions (max support of 10 currently)
  ...Array.from({ length: 10 }, (_, i) => i + 1)
    .map((i) => {
      const vars = [...Array(i).keys()].map((j) => ALPHABET[j]);
      return [
        `function hash${i}Vars(${vars.join(", ")}) -> result {`,
        ...vars.map((v, j) => `mstore(${j * 32}, ${v})`),
        `result := keccak256(0, ${i * 32})`,
        `}`,
      ];
    })
    .flat(),
];

const yulTemplate: string[] = [
  `code {`,
  `/* ---------- constructor ----------- */`,
  ``,
  ``,
  `/* ---------- constructor functions ----------- */`,
  ``,
  ``,
  `/* -------- constructor storage layout ---------- */`,
  ``,
  ``,
  `/* -------- constructor storage access ---------- */`,
  ``,
  ``,
  `/* -------- constructor events ---------- */`,
  ...utilityFunctions,
  ``,
  ``,
  `datacopy(0, dataoffset("runtime"), datasize("runtime"))`,
  `return(0, datasize("runtime"))`,
  `}`,
  ``,
  `object "runtime" {`,
  `code {`,
  `switch selector()`,
  `/* ---------- dispatchers ----------- */`,
  `default {`,
  `revert(0, 0)`,
  `}`,
  ``,
  ``,
  `/* ---------- functions ----------- */`,
  ``,
  ``,
  `/* ---------- calldata decoding functions ----------- */`,
  `function selector() -> s {`,
  `s := div(calldataload(0), 0x100000000000000000000000000000000000000000000000000000000)`,
  `}`,
  `function decodeAsAddress(offset) -> v {`,
  `v := decodeAsUint(offset)`,
  `if iszero(iszero(and(v, not(0xffffffffffffffffffffffffffffffffffffffff)))) {`,
  `revert(0, 0)`,
  `}`,
  `}`,
  `function decodeAsUint(offset) -> v {`,
  `let pos := add(4, mul(offset, 0x20))`,
  `if lt(calldatasize(), add(pos, 0x20)) {`,
  `revert(0, 0)`,
  `}`,
  `v := calldataload(pos)`,
  `}`,
  ``,
  ``,
  `/* ---------- calldata encoding functions ---------- */`,
  `function return256(v) {`,
  `mstore(0, v)`,
  `return(0, 0x20)`,
  `}`,
  `function returnString(v) {`,
  `let length := extract_byte_array_length(v)`,
  `mstore(0, 32)`,
  `mstore(32, length)`,
  `mstore(64, v)`,
  `return(0x00, 0x60)`,
  `}`,
  `function returnArray(v) {`,
  `return(0, v)`,
  `}`,
  `function returnBoolean(v) {`,
  `switch v`,
  `case true {`,
  `return256(1)`,
  `}`,
  `case false {`,
  `return256(0)`,
  `}`,
  `default {`,
  `revert(0, 0)`,
  `}`,
  `}`,
  ``,
  ``,
  `/* -------- storage layout ---------- */`,
  ``,
  ``,
  `/* -------- storage access ---------- */`,
  ``,
  ``,
  `/* -------- events ---------- */`,
  ...utilityFunctions,
  `}`,
  `}`,
  `}`,
];

export default yulTemplate;
